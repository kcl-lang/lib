name: go-test

on:
  push:
    branches:
      - main
      - master
    tags:
      - '*'
  pull_request:
    branches:
      - main
    paths:
      - "go/**"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/go-test.yaml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    strategy:
      matrix:
        include:
          # macOS Intel/ARM configurations

          - os: macos-13
            runner: macos-13
            cgo_enabled: 0

          - os: macos-13-xlarge
            runner: macos-13
            cgo_enabled: 0

          - os: macos-14
            runner: macos-14
            cgo_enabled: 0

          - os: macos-latest
            runner: macos-latest
            cgo_enabled: 0
          
          # Ubuntu configurations

          - os: ubuntu-22.04
            runner: ubuntu-22.04
            cgo_enabled: 0

          - os: ubuntu-latest
            runner: ubuntu-latest
            cgo_enabled: 0
          
          # Windows configurations

          - os: windows-latest
            runner: windows-latest
            cgo_enabled: 0
          
          # Alpine Linux container configurations
          - os: alpine-latest
            runner: ubuntu-latest  # Host runner for the container
            container: golang:1.23-alpine3.19
            cgo_enabled: 1

    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    defaults:
      run:
        working-directory: "go"

    steps:
      - name: Git checkout
        uses: actions/checkout@v6

      - name: Set up Go (non-musl)
        if: matrix.container == null
        uses: actions/setup-go@v6
        with:
          go-version: 1.23
          cache: true

      - name: Install musl dependencies (Alpine container)
        if: matrix.container != null
        run: |
          apk add --no-cache \
            musl-dev \
            gcc \
            git \
            make

      - name: Go mod tidy
        run: go mod tidy

      - name: Setup build tags for Alpine
        if: matrix.container != null
        run: |
          echo "GO_BUILD_TAGS=musl netgo static osusergo" >> $GITHUB_ENV
          echo "GO_LDFLAGS=-linkmode external -extldflags '-static'" >> $GITHUB_ENV

      - name: Go code test (CGO_ENABLED=${{ matrix.cgo_enabled }})
        if: matrix.os != 'windows-latest'
        run: |
          if [ -n "${{ matrix.container }}" ]; then
            BUILD_TAGS="$GO_BUILD_TAGS"
            EXTRA_LDFLAGS="$GO_LDFLAGS"
          fi

          CGO_ENABLED=${{ matrix.cgo_enabled }} \
          go test ./... -v \
            -tags="${BUILD_TAGS}" \
            -ldflags="${EXTRA_LDFLAGS}"
        env:
          CGO_LDFLAGS: ${{ matrix.cgo_enabled == '1' && '-static' || '' }}

      - name: Go code test (CGO_ENABLED=${{ matrix.cgo_enabled }}) on Windows
        if: matrix.os == 'windows-latest'
        run: |
          go test ./... -v
